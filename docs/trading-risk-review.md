# 交易逻辑安全审查记录

> 更新时间：2025-10-28  
> 目标：梳理现有交易核心模块的风险点，便于后续迭代修复

## 1. 行情获取失败时使用固定价格
- **位置**：`src/server/core/services/trading-executor.ts:109`
- **问题**：`get24hrTicker` 调用失败时直接将 `currentPrice` 设为 `1000`，会显著低估或高估所需保证金。
- **风险**：可能在真实价格远高于 1000 USDT 时误判资金充足，从而下出超额订单。
- **建议**：行情失败应直接终止该笔交易，可考虑重试或上报告警，严禁使用固定兜底价格。

## 2. 平仓判断缺失数量校验
- **位置**：`src/server/core/services/trading-executor.ts:118`
- **问题**：`isClosing` 仅依据买卖方向判断，未比较请求数量与已有仓位。
- **风险**：反向下单数量大于持仓时，会被标记为“平仓”而跳过保证金检查，实际却是“反手”开新仓。
- **建议**：新增校验——若 `abs(requestQty)` 大于当前仓位量，则视为开仓，继续执行保证金/风险控制。

## 3. 止盈止损撤单未触发真实 API
- **位置**：`src/server/core/services/trading-executor.ts:386`
- **问题**：`cancelStopOrders` 仅解析自定义 ID 并记录日志，没有调用 Binance 撤单接口。
- **风险**：手动平仓后止盈/止损挂单仍保留，可能在市场反向波动时触发导致意外开仓。
- **建议**：追踪并存储真实 `orderId + symbol`，使用 `binanceService.cancelOrder` 或 `cancelAllOrders` 撤销。

## 4. 资金分配向下取整造成最小成交量问题
- **位置**：`src/server/core/services/futures-capital-manager.ts:65`
- **问题**：保证金和名义金额使用 `Math.floor`，小额仓位会被直接截断为 0。
- **风险**：生成低于币安最小下单阈值的订单，触发 API 错误或导致计划无法执行。
- **建议**：结合交易对精度信息进行 `round`/`truncate` 控制，至少保证数量满足交易所最小步长。

## 5. 风险评分模型过于简化
- **位置**：`src/server/core/services/risk-manager.ts:39`
- **问题**：最大亏损与风险得分基于常数 (`quantity * 1000`、`leverage * 10`)。
- **风险**：忽略实际价格波动、波动率、资金规模等因素，风险评估结果失真。
- **建议**：引入真实入场价、预估波动幅度或历史方差，建立更贴合实盘的风险模型。

---

> 如需补充新的审查项，请在本文件追加条目并标注时间。***
